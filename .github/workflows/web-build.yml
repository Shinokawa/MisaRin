name: Build Web ZIP

on:
  workflow_call:
    inputs:
      version:
        description: Target version used for artifact naming
        required: true
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      APP_VERSION: ${{ inputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
      - name: 启用 Web 目标
        run: flutter config --enable-web
      - name: 获取依赖
        run: flutter pub get
      - name: 构建 Web
        shell: bash
        run: |
          set -euo pipefail
          if flutter build web --help | grep -q -- '--web-renderer'; then
            flutter build web --release --web-renderer canvaskit
          else
            flutter build web --release
          fi
      - name: 打包 ZIP
        shell: bash
        run: |
          set -euo pipefail
          ARTIFACT_DIR="build/artifacts"
          OUTPUT_DIR="build/web"
          mkdir -p "$ARTIFACT_DIR"
          if [[ ! -d "$OUTPUT_DIR" ]]; then
            echo "未找到 Web 构建输出：$OUTPUT_DIR" >&2
            exit 1
          fi
          ARTIFACT_NAME="MisaRin-web-${APP_VERSION}.zip"
          python - <<'PY'
          import os
          import zipfile
          from pathlib import Path
          
          output_dir = Path(os.environ["OUTPUT_DIR"])
          artifact_dir = Path(os.environ["ARTIFACT_DIR"])
          artifact_name = os.environ["ARTIFACT_NAME"]
          dest = artifact_dir / artifact_name
          
          if dest.exists():
              dest.unlink()
          
          with zipfile.ZipFile(dest, "w", compression=zipfile.ZIP_DEFLATED) as zf:
              for path in output_dir.rglob("*"):
                  if path.is_dir():
                      continue
                  zf.write(path, path.relative_to(output_dir))
          
          if not dest.exists() or dest.stat().st_size == 0:
              raise SystemExit(f"打包失败：{dest}")
          print(f"created: {dest} ({dest.stat().st_size} bytes)")
          PY
        env:
          OUTPUT_DIR: build/web
          ARTIFACT_DIR: build/artifacts
          ARTIFACT_NAME: MisaRin-web-${{ env.APP_VERSION }}.zip
      - name: 上传 Web 构建产物
        uses: actions/upload-artifact@v4
        with:
          name: MisaRin-web-${{ env.APP_VERSION }}.zip
          path: build/artifacts/MisaRin-web-${{ env.APP_VERSION }}.zip
          if-no-files-found: error
