name: desktop-release

on:
  push:
    branches:
      - main

permissions:
  contents: write

env:
  FLUTTER_CHANNEL: stable
  DATE_PATTERN: '[0-9]{4}\\.[0-9]{4}'

jobs:
  prepare:
    name: 准备版本信息
    runs-on: ubuntu-latest
    if: ${{ github.ref == 'refs/heads/main' && github.event.head_commit.message != '' && github.event.head_commit.message matches format('.*{0}.*', env.DATE_PATTERN) }}
    outputs:
      release_version: ${{ steps.versions.outputs.release_version }}
      release_build: ${{ steps.versions.outputs.release_build }}
      next_version: ${{ steps.versions.outputs.next_version }}
      next_build: ${{ steps.versions.outputs.next_build }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: 读取版本
        id: versions
        run: |
          bash ci/scripts/get_versions.sh >> "$GITHUB_OUTPUT"

  build:
    name: 构建桌面产物
    runs-on: ${{ matrix.runner }}
    needs: prepare
    if: ${{ needs.prepare.result == 'success' }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os_name: linux
            runner: ubuntu-latest
            arch: x64
            shell: bash
            enable_cmd: flutter config --enable-linux-desktop
            build_cmd: flutter build linux --release
            package_cmd: ci/scripts/build_linux.sh x64
          - os_name: macos
            runner: macos-latest
            arch: universal
            shell: bash
            enable_cmd: flutter config --enable-macos-desktop
            build_cmd: flutter build macos --release
            package_cmd: ci/scripts/build_macos.sh universal
          - os_name: windows
            runner: windows-latest
            arch: x64
            shell: pwsh
            enable_cmd: flutter config --enable-windows-desktop
            build_cmd: flutter build windows --release
            package_cmd: ./ci/scripts/build_windows.ps1 -Arch x64
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: 安装Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}

      - name: 启用桌面目标
        run: ${{ matrix.enable_cmd }}
        shell: ${{ matrix.shell }}

      - name: 获取依赖
        run: flutter pub get
        shell: ${{ matrix.shell }}

      - name: 构建${{ matrix.os_name }}
        run: ${{ matrix.build_cmd }}
        shell: ${{ matrix.shell }}

      - name: 打包产物
        id: package
        run: ${{ matrix.package_cmd }}
        shell: ${{ matrix.shell }}

      - name: 上传${{ matrix.os_name }}制品
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.package.outputs['artifact-name'] }}
          path: ${{ steps.package.outputs['artifact-path'] }}

  release:
    name: 发布Release并更新版本号
    runs-on: ubuntu-latest
    needs:
      - prepare
      - build
    if: ${{ needs.prepare.result == 'success' && needs.build.result == 'success' }}
    env:
      RELEASE_VERSION: ${{ needs.prepare.outputs.release_version }}
      RELEASE_BUILD: ${{ needs.prepare.outputs.release_build }}
      NEXT_VERSION: ${{ needs.prepare.outputs.next_version }}
      NEXT_BUILD: ${{ needs.prepare.outputs.next_build }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: 下载全部制品
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: 发布Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.RELEASE_VERSION }}
          name: misa-rin ${{ env.RELEASE_VERSION }}
          body: |
            自动发布版本: ${{ env.RELEASE_VERSION }}+${{ env.RELEASE_BUILD }}
            - Linux: linux-x64-${{ env.RELEASE_VERSION }}
            - macOS: macos-universal-${{ env.RELEASE_VERSION }}
            - Windows: windows-x64-${{ env.RELEASE_VERSION }}
          files: |
            dist/**/*.tar.gz
            dist/**/*.dmg
            dist/**/*.zip
          draft: false
          prerelease: false
          allowUpdates: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 配置Git信息
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: 更新版本号
        run: |
          bash ci/scripts/bump_version.sh "${{ env.NEXT_VERSION }}" "${{ env.NEXT_BUILD }}"

      - name: 推送版本号变更
        run: |
          if git status --porcelain | grep -q .; then
            git commit -am "chore: bump version to ${NEXT_VERSION}+${NEXT_BUILD}"
            git push origin HEAD:main
          else
            echo "无文件变动，跳过推送"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
