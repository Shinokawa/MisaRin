# macOS 性能验收指标（SAI2 级“瞬间流畅”）

本文把“流畅”拆成可量化、可复现、可判定的指标，后续所有实现（Rust GPU 画布权威状态 + Flutter 仅显示 Texture/收集输入/UI 状态）都以此为准，避免“体感争论”。

## 范围与前置条件

- 平台：macOS（目标 120Hz；最低 60Hz 不抖、不明显断触）。
- 已能打开画布页并画线。
- 可查看日志与 DevTools（Release/Profile 任选，推荐 Profile 做对比、Release 做最终验收）。

## 必须达标的指标（MVP 红线）

### 1) 输入到像素出现（input→present）

定义（验收时必须固定定义）：
- **input**：一次笔触输入样本被 UI 线程（Dart）接收并进入“画布命令队列/笔刷提交”。
- **present**：该输入引起的画面更新首次出现在屏幕（或 Flutter 引擎认为该帧完成呈现）。

验收阈值（以整段压测期间采样统计）：
- `P50 < 8ms`
- `P95 < 16ms`

> 说明：`8ms/16ms` 分别对应 120Hz/60Hz 的一帧预算；目标是 120Hz 主观“瞬间跟手”，同时 60Hz 下不出现明显抖动。

### 2) 输入点吞吐（10 秒快速涂抹不断触）

固定压测条件下（见下文“压测入口”）：
- **持续 10 秒**连续画（无停顿），**输入点吞吐 ≥ 1000 点/秒**（持续，不是峰值）。
- 观感上不出现“明显断触/断线”（输入样本被丢弃或延迟到可见断裂）。

### 3) UI 线程（Dart）负载上限

约束（性质要求）：
- 画画过程中 **UI 线程不得承担任何像素合成/像素格式转换**（例如把整幅/大块像素搬到 Dart 再处理）。

验收阈值（整段压测期间统计）：
- UI 线程（Dart）`Frame build` 耗时 `P95 < 4ms`

## 压测入口（固定参数）

压测参数（必须固定，不允许随意改口径）：
- 画布：`2048 x 2048`
- 图层：`4` 层（包含背景层）
- 时长：`10s`
- 连续画：目标输入点吞吐 `1000 点/秒`（持续）

运行方式（命令行入口）：
- 启动时传入：`--dart-define=MISA_RIN_CANVAS_PERF_STRESS=1`
- 示例（Profile）：`flutter run -d macos --profile --dart-define=MISA_RIN_CANVAS_PERF_STRESS=1`

运行后预期：
- 自动进入压测画布页并执行 10 秒连续画。
- 结束时输出一段汇总日志（至少包含：input→present P50/P95、点吞吐、UI build P95）。

## 记录与判定

- 同一台机器、同一套参数至少跑 3 次，取中位数作为对比基线。
- 若未达标：优先检查 `docs/hard_bans_macos.md` 是否触发（触发即直接判失败，不进入“优化讨论”）。

